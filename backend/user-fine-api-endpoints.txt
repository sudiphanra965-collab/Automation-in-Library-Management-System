// Add these endpoints to server-https.js

// ========== USER MANAGEMENT ENDPOINTS ==========

// Get all users with borrowed book count
app.get('/api/admin/users', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const users = await all(`
      SELECT 
        u.id,
        u.username,
        u.email,
        u.is_admin,
        COUNT(bb.id) as borrowed_count
      FROM users u
      LEFT JOIN borrowed_books bb ON u.id = bb.user_id
      GROUP BY u.id
      ORDER BY u.id
    `);
    
    res.json(users);
  } catch (error) {
    console.error('Get users error:', error);
    res.status(500).json({ error: 'Failed to get users' });
  }
});

// Get user details
app.get('/api/admin/user/:id/details', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const userId = req.params.id;
    
    const user = await get(`
      SELECT 
        u.id,
        u.username,
        u.email,
        u.is_admin,
        COUNT(bb.id) as borrowed_count
      FROM users u
      LEFT JOIN borrowed_books bb ON u.id = bb.user_id
      WHERE u.id = ?
      GROUP BY u.id
    `, [userId]);
    
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    res.json(user);
  } catch (error) {
    console.error('Get user details error:', error);
    res.status(500).json({ error: 'Failed to get user details' });
  }
});

// Toggle user role (make admin/remove admin)
app.post('/api/admin/user/:id/toggle-role', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const userId = req.params.id;
    
    // Get current role
    const user = await get('SELECT is_admin FROM users WHERE id = ?', [userId]);
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    // Toggle role
    const newRole = user.is_admin ? 0 : 1;
    await run('UPDATE users SET is_admin = ? WHERE id = ?', [newRole, userId]);
    
    res.json({ message: 'User role updated successfully', is_admin: newRole });
  } catch (error) {
    console.error('Toggle user role error:', error);
    res.status(500).json({ error: 'Failed to update user role' });
  }
});

// Delete user
app.delete('/api/admin/user/:id', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const userId = req.params.id;
    
    // Check if user has borrowed books
    const borrowed = await get('SELECT COUNT(*) as count FROM borrowed_books WHERE user_id = ?', [userId]);
    if (borrowed.count > 0) {
      return res.status(400).json({ error: 'Cannot delete user with borrowed books' });
    }
    
    // Delete user
    await run('DELETE FROM users WHERE id = ?', [userId]);
    
    res.json({ message: 'User deleted successfully' });
  } catch (error) {
    console.error('Delete user error:', error);
    res.status(500).json({ error: 'Failed to delete user' });
  }
});

// ========== FINE MANAGEMENT ENDPOINTS ==========

// Get all fines (overdue books)
app.get('/api/admin/fines', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const fines = await all(`
      SELECT 
        bb.id as borrow_id,
        bb.user_id,
        u.username,
        bb.book_id,
        b.title as book_title,
        bb.borrow_date,
        datetime(bb.borrow_date, '+14 days') as due_date,
        CAST((julianday('now') - julianday(datetime(bb.borrow_date, '+14 days'))) AS INTEGER) as days_overdue,
        CAST((julianday('now') - julianday(datetime(bb.borrow_date, '+14 days'))) * 5 AS INTEGER) as fine_amount,
        COALESCE(bb.fine_paid, 0) as fine_paid
      FROM borrowed_books bb
      JOIN users u ON bb.user_id = u.id
      JOIN books b ON bb.book_id = b.id
      WHERE datetime(bb.borrow_date, '+14 days') < datetime('now')
      ORDER BY days_overdue DESC
    `);
    
    res.json(fines);
  } catch (error) {
    console.error('Get fines error:', error);
    res.status(500).json({ error: 'Failed to get fines' });
  }
});

// Mark fine as paid
app.post('/api/admin/fine/:borrowId/mark-paid', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const borrowId = req.params.borrowId;
    
    await run('UPDATE borrowed_books SET fine_paid = 1 WHERE id = ?', [borrowId]);
    
    res.json({ message: 'Fine marked as paid successfully' });
  } catch (error) {
    console.error('Mark fine paid error:', error);
    res.status(500).json({ error: 'Failed to mark fine as paid' });
  }
});

// Send fine reminder (placeholder - would integrate with email/notification system)
app.post('/api/admin/fine/:userId/send-reminder', authenticateToken, authorizeAdmin, async (req, res) => {
  try {
    const userId = req.params.userId;
    
    // In a real system, this would send an email or push notification
    // For now, just log it
    console.log(`Fine reminder sent to user ${userId}`);
    
    res.json({ message: 'Reminder sent successfully' });
  } catch (error) {
    console.error('Send reminder error:', error);
    res.status(500).json({ error: 'Failed to send reminder' });
  }
});
